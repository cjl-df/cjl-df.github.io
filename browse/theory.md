### 浏览器概述及多进程简介

### 1. 浏览器简介

  * 概述
  
        分类：   现在主要有五大主流浏览器: Chrome(webkit->Blink), Internet Explorer(Trident), Firefox(Geoko), 
                Safari(webkit) and Opera(webkit->blink).
                移动端上是Android Browser,iPhone, Opera Mini and Opera Mobile, UC Browser, 
                the Nokia S40/S60 browsers,除了Opera，这些浏览器都是基于
                WebKit内核的（目前可能有变）。
  
        功能：   根据W3C制定的一系列规范，从服务端请求并渲染资源
  
        普遍外观：地址栏，前进后退，书签，刷新及取消，主页，插件
  
        深层结构：下边主要介绍———渲染引擎及JS引擎
  
        工作方式：多进程
        
    ![test](https://image-static.segmentfault.com/168/527/1685277292-5a65972377cb0）

  * 组成
  
        用户界面（User Interface)  ：包括地址栏、前进/后退按钮、书签菜单等。除了浏览器主窗口显示的您请求的页面外，其他
                                   显示的各个部分都属于用户界面。
  
        浏览器引擎（Browser engine）：在用户界面和呈现引擎之间传送指令。
  
        呈现引擎（Rendering engine）：负责显示请求的内容。如果请求的内容是 HTML，它就负责解析 HTML 和 CSS 内容,
                                    并将解析后的内容显示在屏幕上。
  
        网络（Networking） ：         用于网络调用，比如 HTTP 请求。其接口与平台无关，并为所有平台提供底层实现。
  
        用户界面后端（UI backend）：   用于绘制基本的窗口小部件，比如组合框和窗口。其公开了与平台无关的通用接口，
                                    而在底层使用操作系统的用户界面方法。
  
        JavaScript 解释器（JS Interpreter）：用于解析和执行 JavaScript 代码。
  
        数据存储（Datapersistence）：这是持久层。浏览器需要在硬盘上保存各种数据，例如 Cookie，storage。
                                   新的 HTML 规范 (HTML5) 定义了“网络数据库”，这是一个完整
                                   但是轻便）的浏览器内数据库。

  * 浏览器多进程
  
      *知道了浏览器是多进程后，再来看看它到底包含哪些进程：（为了简化理解，仅列举主要进程）*

        Browser进程：浏览器的主进程（负责协调、主控），只有一个。作用有
                    负责浏览器界面显示，与用户交互。如前进，后退等
                    负责各个页面的管理，创建和销毁其他进程
                    将Renderer进程得到的内存中的Bitmap，绘制到用户界面上
                    网络资源的管理，下载等
  
        第三方插件进程：每种类型的插件对应一个进程，仅当使用该插件时才创建
  
        GPU进程：      最多一个，用于3D绘制等
  
        浏览器渲染进程（浏览器内核）（Renderer进程，内部是多线程的）：默认每个Tab页面一个进程，互不影响。
                      主要作用为页面渲染，脚本执行，事件处理等
  
        强化记忆：     在浏览器中打开一个网页相当于新起了一个进程（进程内有自己的多线程）
  
* 重点是浏览器内核（渲染进程）
  
  *浏览器的渲染进程是多线程的，包含如下线程*
 
  * GUI渲染线程
  
        1. 负责渲染浏览器界面，解析HTML，CSS，构建DOM树和RenderObject树，布局和绘制等。
   
        2 当界面需要重绘（Repaint）或由于某种操作引发回流(reflow)时，该线程就会执行
   
        3 注意，GUI渲染线程与JS引擎线程是互斥的，当JS引擎执行时GUI线程会被挂起（相当于被冻结了），
          GUI更新会被保存在一个队列中等到JS引擎空闲时立即被执行。
  
  * 引擎线程
     
        1 也称为JS内核，负责处理Javascript脚本程序。（例如V8引擎）
     
        2 JS引擎线程负责解析Javascript脚本，运行代码。
  
        3 JS引擎一直等待着任务队列中任务的到来，然后加以处理，一个Tab页（renderer进程）
          中无论什么时候都只有一个JS线程在运行JS程序
     
        4 同样注意，GUI渲染线程与JS引擎线程是互斥的，所以如果JS执行的时间过长，
          这样就会造成页面的渲染不连贯，导致页面渲染加载阻塞。
  
   * 事件触发线程
      
         1 归属于浏览器而不是JS引擎，用来控制事件循环（可以理解，JS引擎自己都忙不过来，需要浏览器另开线程协助）
    
         2 当JS引擎执行代码块如setTimeOut时（也可来自浏览器内核的其他线程,如鼠标点击、AJAX异步请求等），
           会将对应任务添加到事件线程中
  
         3 当对应的事件符合触发条件被触发时，该线程会把事件添加到待处理队列的队尾，等待JS引擎的处理
  
         4 注意，由于JS的单线程关系，所以这些待处理队列中的事件都得排队等待JS引擎处理（当JS引擎空闲时才会去执行）

   * 定时触发器线程
    
         1 传说中的setInterval与setTimeout所在线程
  
         1 浏览器定时计数器并不是由JavaScript引擎计数的,（因为JavaScript引擎是单线程的, 
           如果处于阻塞线程状态就会影响记计时的准确）
     
         3 因此通过单独线程来计时并触发定时（计时完毕后，添加到事件队列中，等待JS引擎空闲后执行）
  
         4 注意，W3C在HTML标准中规定，规定要求setTimeout中低于4ms的时间间隔算为4ms。
  
   * 异步http请求线程
   
         1 在XMLHttpRequest在连接后是通过浏览器新开一个线程请求
  
         2 将检测到状态变更时，如果设置有回调函数，异步线程就产生状态变更事件，将这个回调再放入事件队列中。
           再由JavaScript引擎执行。
           
    ![test](./test.png）    
    
    
 ### 2. Browser进程和浏览器内核（Renderer进程）的通信过程
 
     首先，应该对浏览器内的进程和线程都有一定理解了，那么接下来，再谈谈浏览器的Browser进程（控制进程）是如何和内核通信的，
         这点也理解后，就可以将这部分的知识串联起来，从头到尾有一个完整的概念。
     如果自己打开任务管理器，然后打开一个浏览器，就可以看到：任务管理器中出现了两个进程（一个是主控进程，
         一个则是打开Tab页的渲染进程），
     然后在这前提下，看下整个的过程：(简化了很多)
     
     1. Browser进程收到用户请求，首先需要获取页面内容（譬如通过网络下载资源），
        随后将该任务通过RendererHost接口传递给Render进程
   
     2. Renderer进程的Renderer接口收到消息，简单解释后，交给渲染线程，然后开始渲染

        2.1 渲染线程接收请求，加载网页并渲染网页，这其中可能需要Browser进程获取资源和需要GPU进程来帮助渲染
        
        2.2 当然可能会有JS线程操作DOM（这样可能会造成回流并重绘）
        
     3. 最后Render进程将结果传递给Browser进程
     
     Browser进程接收到结果并将结果绘制出来
